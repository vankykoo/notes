# Linux高级

## 一、日志管理

###1）介绍

日志文件是重要的系统信息文件，其中记录了许多重要的系统事件，包括用户的登录信息，系统的启动信息、系统的安全信息，邮件相关信息，各种服务相关信息。

日志对于安全来说很重要，它记录了系统每天发生的各种事情，通过日志来检查错误发生的原因，或者受到攻击时攻击者留下的痕迹。

日志保存在/var/log目录下。



### 2）常用系统日志

![](C:\Users\86180\Desktop\picPick\053.png)



## 二、日志管理服务rsyslogd

### 1）介绍

CentOS7.6日志服务是rsyslogd，CentOS6.x日志服务是syslogd。rsyslogd功能更强大，rsyslogd的使用、日志文件的格式，和syslogd服务是兼容的



### 2）常用指令

* ps aux | grep "rsyslog" | grep -v "grep" ：查询Linux中的rsyslogd服务是否启动
* systemctl list-unit-files | grep rsyslog ：查询rsyslogd服务的自启动状态
* 配置文件：/etc/rsyslog.conf



### 3）文件格式

编辑文件时的格式为： \*.\* 存放日志文件

其中第一个\*代表日志类型，第二个\*代表日志级别。

![](C:\Users\86180\Desktop\picPick\054.png)

![](C:\Users\86180\Desktop\picPick\055.png)



* 日志文件的格式包含以下四列：
  * 事件产生的时间
  * 产生事件的服务器的主机名
  * 产生事件的服务名或程序名
  * 事件的具体信息



### 4）自定义日志

在/etc/rsyslog.conf中添加

```shell
*.*								/var/log/vanky.log #日志存放的位置
```





## 三、日志轮替

### 1）介绍

日志轮替就是把旧的日志文件移动并改名，同时建立新的空日志文件，当旧日志文件超出保存的范围之后，就会进行删除。

> **日志轮换**是一种日志管理策略，可以简化管理。它主要用于处理日志文件的增长，防止日志文件过大而占用过多的磁盘空间。
>
> 日志轮换的过程通常包括以下几个步骤：
>
> 1. **创建新的日志文件**：当达到一定的轮换条件（如文件大小、行数或时间等）时，会创建一个新的日志文件，并将新的日志信息写入新的文件中。
> 2. **重命名旧的日志文件**：同时，旧的日志文件会被重命名，通常是在文件名后添加一个序号或时间戳。
> 3. **删除过旧的日志文件**：为了防止磁盘空间被无限制地占用，通常会设置一个保留旧日志文件的数量。当超过这个数量时，最旧的日志文件将被删除。
>
> 这样，通过日志轮换，我们可以有效地管理日志文件，同时也能保证我们可以查看到一段时间内的历史日志信息。



### 2）日志轮替文件命名

* centos7使用logrotate进行日志轮替管理，要想改变日志轮替文件名字，通过 /etc/logrotate.conf配置文件中“dateext”参数；
* 如果配置文件中有“dateext”参数，那么日志会用日期来作为日志文件的后缀，例如“secure-20201010”，这样日志名不会重叠，也就不需要日志文件的改名。只需要指定保存日志个数，删除多余的日志文件即可。
* 如果配置文件中没有“dateext”参数，日志文件就需要进行改名了。当第一次进行日志轮替时，“secure.1”会自动改名为“secure.2”，当前的“secure”日志会自动改名为“secure.1”，然后也会新建“secure”日志，用来保存新的日志，以此类推。



### 3）配置文件

![](C:\Users\86180\Desktop\picPick\056.png)



### 4）logrotate配置文件参数

`logrotate`的配置文件参数主要包括：

- `compress`：通过gzip压缩转储以后的日志。
- `nocompress`：不压缩。
- `copytruncate`：用于还在打开中的日志文件，把当前日志备份并截断。
- `nocopytruncate`：备份日志文件但是不截断。
- `create mode owner group`：转储文件，使用指定的文件模式创建新的日志文件。
- `nocreate`：不建立新的日志文件。
- `delaycompress`：和 compress 一起使用时，转储的日志文件到下一次转储时才压缩。
- `nodelaycompress`：覆盖 delaycompress 选项，转储同时压缩。

此外，还有一些其他参数，如：

- `daily`、`weekly`、`monthly`、`yearly`：切割周期，多久切割一次。例如，daily表示每天切割一次。
- `size size`：当日志文件到达指定的大小时才转储。默认单位是bytes。bytes (缺省) 及 KB (sizek) 或 MB (sizem)。例如，size 30k、size 50M。
- `rotate count`：日志文件保留备份的个数。默认是0。例如，0表示没有备份；5表示保留最近的5个备份，其余的全部删除。
- `maxage count`：保留多少天的日志文件。例如，5表示保留最近的5天的日志文件，其余的全部删除。如果日志文件按天转储，则rotate与maxage基本上是一样的[](https://blog.csdn.net/xiaojin21cen/article/details/122309230)。
- `missingok`：如果日志文件不存在，logrotate将不会产生错误消息。

![](C:\Users\86180\Desktop\picPick\057.png)





### 5）日志轮替的机制原理

日志轮替之所以可以在指定的时间备份日志，是依赖系统定时任务，在/etc/cron.daily/目录，就会发现这个目录中是有logrotate文件（可执行），logrotate通过这个文件依赖定时任务执行的。



![](C:\Users\86180\Desktop\picPick\058.png)



### 6）内存日志

* 介绍

  > **内存日志通常是指记录操作系统或应用程序对内存使用情况的日志**。这些日志可以帮助我们了解系统或应用程序的运行状态，例如，哪些进程在使用内存，使用了多少内存，内存使用率如何变化等。
  >
  > 在Linux系统中，我们可以使用一些命令来查看实时的内存使用情况，例如`free`、`top`和`ps`等命令。此外，`dmesg`命令可以查看Linux内核日志，包括启动信息和硬件故障信息等。
  >
  > 如果需要长期保存这些信息，就需要借助于日志服务了。在Linux系统中，rsyslog服务负责收集和记录系统日志。根据rsyslog服务的配置，可以将内核和系统程序消息记录到指定位置。
  >
  > 总的来说，内存日志是一种重要的系统监控工具，可以帮助我们了解和优化系统的性能。

  内存日志在重启后会清空。

* 常用指令

  ![](C:\Users\86180\Desktop\picPick\059.png)







## 四、创建自己的Linux

### 步骤

1. 创建一块新的磁盘
2. 给新建的磁盘分区
3. 给新建的分区格式化
4. 把分区进行挂载
5. 修改配置文件grub.cfg
6. 创建目标主机根文件系统
7. 拷贝需要的bash和库文件给新的系统使用



##五、内核升级

### 常用命令

* uname -a：查看当前版本的内核版本
* yum info kernel -q：检测内核版本，显示可以升级的内核
* yum update kernel：升级内核
* yum list kernel  -q：查看已经安装的内核





## 六、备份和恢复

实体机无法做快照，如果系统出现异常或者数据损坏，后果严重，要重做系统，还会造成数据丢失。

Linux的备份和恢复有两种方式：

1. 把需要的文件（或者分区）用TAR打包，下次需要恢复的时候再解压开覆盖。
2. 使用dump和restore。



### 1）dump备份

* 介绍

  dump支持分卷和增量备份（增量备份是指备份上次备份后 修改/增加过的文件，也称差异备份）。

* 语法说明

  ![](C:\Users\86180\Desktop\picPick\061.png)

  例子：将/boot分区所有内容备份到/opt/boot.bak0.bz2文件中，备份层级为0，

  `dump -0uj -f /opt/boot.bak0.bz2 /boot`

  * 查看备份时间：`cat /etc/dumpdates`

* 提醒：

  如果是重要的备份文件，比如数据区，建议将文件上传到其它服务器保存，

> 在使用`dump`命令进行备份时，如果你首次对一个子目录进行备份，且使用的是0级别，那么命令会正常执行，因为0级别代表完全备份。然而，如果你试图对同一个子目录进行非0级别（例如1级别）的备份，就会出现"DUMP: Only level 0 dumps are allowed on a subdirectory"的错误信息。这是因为对于子目录的备份，`dump`命令只支持0级别的完全备份。如果有任何问题，请随时向我提问！



### 2）恢复

* 介绍：restore命令用来恢复已备份的文件，可以从dump生成的备份文件中恢复原文件。

* 基本语法：restore [模式选项] \[选项]

* 四个模式（只能用一种）

  * -C：使用对比模式，将备份的文件与已存在的文件相互对比。
  * -i：使用交互模式，在进行还原操作时，restore指令将依序询问用户
  * -r：进行还原模式
  * -t：查看模式，看备份文件有哪些文件

  > 在数据恢复中，通常有以下几种模式：
  >
  > 1. **完全恢复**：完全恢复是指**将数据恢复到最后一次备份的状态**。这通常需要一个完整的备份文件，以及从那次备份之后所有的增量备份文件。
  > 2. **增量恢复**：增量恢复是指**从上一次完全或增量备份之后，将所有更改过的数据恢复过来**。这通常需要一个完整的备份文件，以及一个或多个增量备份文件。
  > 3. **差异恢复**：差异恢复是指从上一次完全备份之后，**将所有更改过的数据恢复过来**。这通常需要一个完整的备份文件，以及一个差异备份文件。
  > 4. **灾难恢复**：灾难恢复是指在系统发生严重故障时，如硬盘损坏或数据丢失，将系统恢复到可用状态。这通常需要一个系统镜像，以及所有的系统设置和用户数据。
  >
  > 以上就是数据恢复的几种模式，不同的模式适用于不同的场景，选择哪种模式取决于你的具体需求和备份策略。

* 选项：

  * -f <备份设备> ：从指定文件中读取备份数据，进行还原操作。





## 七、可视化管理

webmin和bt宝塔

























































